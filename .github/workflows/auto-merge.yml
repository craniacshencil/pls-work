name: Auto-merge All PRs
on:
  pull_request_target:
    types: [opened, synchronize]

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check for deletions
        id: check_deletions
        run: |
          # Get the diff stats
          DIFF_STATS=$(gh pr diff ${{ github.event.pull_request.number }} --stat)
          echo "$DIFF_STATS"
          
          # Extract deletions count (look for pattern like "1 file changed, 5 insertions(+), 3 deletions(-)")
          DELETIONS=$(echo "$DIFF_STATS" | grep -oP '\d+(?= deletion)' || echo "0")
          
          echo "Deletions found: $DELETIONS"
          
          if [ "$DELETIONS" -gt 0 ]; then
            echo "has_deletions=true" >> $GITHUB_OUTPUT
          else
            echo "has_deletions=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Comment and close if deletions found
        if: steps.check_deletions.outputs.has_deletions == 'true'
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "‚ùå **Error: Deleting is not allowed**\nThis PR contains deletions and cannot be merged. Please only add new content without removing existing lines."
          gh pr close ${{ github.event.pull_request.number }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Merge PR if no deletions
        if: steps.check_deletions.outputs.has_deletions == 'false'
        run: |
          gh pr merge ${{ github.event.pull_request.number }} --merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

